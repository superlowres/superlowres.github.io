/* 
       _            _       _     _         _                  _             _            _           _           _                     _         _                   _                      _             _                   _             _            _        _          _             _     
      /\ \         / /\    / /\  /\ \      / /\               / /\      _   /\ \         /\ \        _\ \        /\ \                  /\ \      / /\                / /\                   _\ \          / /\                /\ \     _    /\ \         /\ \     /\ \       _\ \          _\ \   
      \_\ \       / / /   / / /  \ \ \    / /  \             / / /    / /\ /  \ \       /  \ \      /\__ \      /  \ \____             \ \ \    / /  \              / /  \                 /\__ \        / /  \              /  \ \   /\_\ /  \ \____   /  \ \    \ \ \     /\__ \        /\__ \  
      /\__ \     / /_/   / / /   /\ \_\  / / /\ \__         / / /    / / // /\ \ \     / /\ \ \    / /_ \_\    / /\ \_____\            /\ \_\  / / /\ \__          / / /\ \               / /_ \_\      / / /\ \            / /\ \ \_/ / // /\ \_____\ / /\ \ \   /\ \_\   / /_ \_\      / /_ \_\ 
     / /_ \ \   / /\ \__/ / /   / /\/_/ / / /\ \___\       / / /_   / / // / /\ \ \   / / /\ \_\  / / /\/_/   / / /\/___  /           / /\/_/ / / /\ \___\        / / /\ \ \             / / /\/_/     / / /\ \ \          / / /\ \___/ // / /\/___  // / /\ \_\ / /\/_/  / / /\/_/     / / /\/_/ 
    / / /\ \ \ / /\ \___\/ /   / / /    \ \ \ \/___/      / /_//_/\/ / // / /  \ \_\ / / /_/ / / / / /       / / /   / / /           / / /    \ \ \ \/___/       / / /  \ \ \           / / /         / / /  \ \ \        / / /  \/____// / /   / / // /_/_ \/_// / /    / / /         / / /      
   / / /  \/_// / /\/___/ /   / / /      \ \ \           / _______/\/ // / /   / / // / /__\/ / / / /       / / /   / / /           / / /      \ \ \            / / /___/ /\ \         / / /         / / /___/ /\ \      / / /    / / // / /   / / // /____/\  / / /    / / /         / / /       
  / / /      / / /   / / /   / / /   _    \ \ \         / /  \____\  // / /   / / // / /_____/ / / / ____  / / /   / / /           / / /   _    \ \ \          / / /_____/ /\ \       / / / ____    / / /_____/ /\ \    / / /    / / // / /   / / // /\____\/ / / /    / / / ____    / / / ____   
 / / /      / / /   / / /___/ / /__ /_/\__/ / /        /_/ /\ \ /\ \// / /___/ / // / /\ \ \  / /_/_/ ___/\\ \ \__/ / /        ___/ / /__ /_/\__/ / /         / /_________/\ \ \     / /_/_/ ___/\ / /_________/\ \ \  / / /    / / / \ \ \__/ / // / /   ___/ / /__  / /_/_/ ___/\ / /_/_/ ___/\ 
/_/ /      / / /   / / //\__\/_/___\\ \/___/ /         \_\//_/ /_/ // / /____\/ // / /  \ \ \/_______/\__\/ \ \___\/ /        /\__\/_/___\\ \/___/ /         / / /_       __\ \_\   /_______/\__\// / /_       __\ \_\/ / /    / / /   \ \___\/ // / /   /\__\/_/___\/_______/\__\//_______/\__\/ 
\_\/       \/_/    \/_/ \/_________/ \_____\/              \_\/\_\/ \/_________/ \/_/    \_\/\_______\/      \/_____/         \/_________/ \_____\/          \_\___\     /____/_/   \_______\/    \_\___\     /____/_/\/_/     \/_/     \/_____/ \/_/    \/_________/\_______\/    \_______\/     
                                                                                                                                                                                                                                                                                                  

        _   _         _                   _              _            _                  _            _                  _            _                   _        _       
       /\_\/\_\ _    / /\                /\_\           /\ \         /\_\               / /\         /\ \               /\ \         /\ \                /\ \     /\ \     
      / / / / //\_\ / /  \              / / /  _       /  \ \       / / /         _    / /  \       /  \ \             /  \ \       /  \ \               \ \ \    \_\ \    
     /\ \/ \ \/ / // / /\ \            / / /  /\_\    / /\ \ \      \ \ \__      /\_\ / / /\ \__   / /\ \ \           / /\ \ \     / /\ \ \              /\ \_\   /\__ \   
    /  \____\__/ // / /\ \ \          / / /__/ / /   / / /\ \_\      \ \___\    / / // / /\ \___\ / / /\ \_\         / / /\ \ \   / / /\ \_\            / /\/_/  / /_ \ \  
   / /\/________// / /  \ \ \        / /\_____/ /   / /_/_ \/_/       \__  /   / / / \ \ \ \/___// /_/_ \/_/        / / /  \ \_\ / /_/_ \/_/           / / /    / / /\ \ \ 
  / / /\/_// / // / /___/ /\ \      / /\_______/   / /____/\          / / /   / / /   \ \ \     / /____/\          / / /   / / // /____/\             / / /    / / /  \/_/ 
 / / /    / / // / /_____/ /\ \    / / /\ \ \     / /\____\/         / / /   / / /_    \ \ \   / /\____\/         / / /   / / // /\____\/            / / /    / / /        
/ / /    / / // /_________/\ \ \  / / /  \ \ \   / / /______        / / /___/ / //_/\__/ / /  / / /______        / / /___/ / // / /              ___/ / /__  / / /         
\/_/    / / // / /_       __\ \_\/ / /    \ \ \ / / /_______\      / / /____\/ / \ \/___/ /  / / /_______\      / / /____\/ // / /              /\__\/_/___\/_/ /          
        \/_/ \_\___\     /____/_/\/_/      \_\_\\/__________/      \/_________/   \_____\/   \/__________/      \/_________/ \/_/               \/_________/\_\/           
                                                                                                                                                                           
         NathanaÃ«l Vianin 2020
 */
document.querySelector("#load").onchange = Load();

const NodeTypes = [
    "testNode"
]

var nodeBrowser;
var topBar;

var viewPortSize;

var thing;

const Nodes = [];

var activeNodes = [];
var NodeLinks = [];

var grabbing = false;
var dragNdropping = false;
var linking = false;
var mouseIsReleased;
var userDoubleClicked;

var link1;
var link2;

var previewingInBackground = false;
var previewedNode;

function preload() {}

function setup() {
    createCanvas(window.innerWidth, window.innerHeight);
    this.doubleClicked();
    rectMode(CORNERS);
    strokeWeight(2);
    NodesInit();
    nodeBrowser = new NodeBrowser();
    topBar = new TopBar();

    calculateViewportSize();
}

function draw() {
    background(100);

    previewNode();

    updateNodes();
    drawNodes();

    linkingBehaviour();

    nodeBrowser.update();
    topBar.update();

    GarbageCollection();
    userDoubleClicked = false;
    mouseIsReleased = false;
}

function windowResized() {
    resizeCanvas(window.innerWidth, window.innerHeight);
    calculateViewportSize();
}

function isSquareGrabbed(object, x, y, x1, y1) {
    if ((((mouseX > x && mouseX < x1) || object.grabbed) && mouseIsPressed && (isGrabbable(object) || object.isBrowser)) || object.grabbed) {
        if ((mouseY > y && mouseY < y1) || object.grabbed) {
            return true;
        }
    }
    return false;
}

function isSquareHovered(x, y, x1, y1) {
    if (mouseX > x && mouseX < x1) {
        if (mouseY > y && mouseY < y1) {
            return true;
        }
    }
    return false;
}

function isGrabbed(object, x, y, range) {
    return (((dist(x, y, mouseX, mouseY) < range || object.grabbed) && mouseIsPressed && isGrabbable(object)) || object.grabbed)
}

function previewNode() {
    if (topBar.elements[2].active && previewedNode != null) {
        image(previewedNode, (width - height) / 2, 0, height, height);
    }
}

function grab(object, xProperty, yProperty,
    minX = null, maxX = null,
    minY = null, maxY = null) {
    if (object.sliderPos == null) {
        if (xProperty != false) {
            xProperty = xProperty || "x";
        }
    }
    yProperty = yProperty || "y";

    if (mouseIsPressed && (!grabbing || object.grabbed)) {
        grabbing = true;
        object.grabbed = true;

        const d = createVector(mouseX - pmouseX, mouseY - pmouseY)
        if (xProperty != false) {
            //update X
            if (xProperty != null) {
                object[xProperty] += d.x;
                //clamping X
                if (minX != null && maxX != null) {
                    if (object[xProperty] < minX) {
                        object[xProperty] = minX;
                    } else if (object[xProperty] > maxX) {
                        object[xProperty] = maxX;
                    }
                }
            }

            //update Y
            if (yProperty != null) {
                object[yProperty] += d.y;
                //clamping Y
                if (minY != null && maxY != null) {
                    if (object[yProperty] < minY) {
                        object[yProperty] = minY;
                    } else if (object[yProperty] > maxY) {
                        object[yProperty] = maxY;
                    }
                }
            }
        }
    } else {

        if (!mouseIsPressed) {
            grabbing = false;
            object.grabbed = false;
            console.log("grab stopped");
        }
    }
}

function mouseReleased() {
    if (linking) { finishLink() };
    mouseIsReleased = true;
    dragNdropping = false;

}

function keyPressed(key) {

    if (key.key == "a") {
        spawnNode(mouseX, mouseY, "test");
    }
}

function linkingBehaviour() {
    if (link2 != null) {
        if (dist(link2.x, link2.y, mouseX, mouseY) > SETTINGS.pinRadius) {
            link2 = null;
        }
    }
}

function finishLink() {
    console.log("finishing linking");
    if (link2 != null) {
        link1.link = link2;
        /* link1.linkedTo.push(link2); */
        link2.link = link1;
        /* link2.linkedTo.push(link1); */
    }
    link1.grabbed = false;
    grabbing = false;
    link1 = null;
    link2 = null;
    linking = false;
    console.log("finished Link")
}


function updateNodes() {
    for (var i = 0; i < activeNodes.length; i++) {
        activeNodes[i].update();
    }
}

function drawNodes() {
    for (var i = 0; i < activeNodes.length; i++) {
        activeNodes[i].draw();
    }
}

function NodesInit() {
    /* spawnNode(0, 0, "test", true); */
    spawnNode(0, 0, "noise", true);
    spawnNode(0, 0, "RDfilter", true);
    spawnNode(0, 0, "camera", true);
    spawnNode(0, 0, "math", true);
    /* testNode.Ins.push(new NodePin(testNode, true)); */
}

function spawnNode(x, y, type, isBrowser) {
    type = type || "RDfilter";
    console.log("creating node on", x, y);
    var n = new Node();
    n.x = x;
    n.y = y;
    switch (type) {
        case "test":
            n.createPin(true);
            n.name = "Test"
            n.type = "test";

            break;
        case "noise":
            n.createPin(false);
            n.createPin(true);
            n.Outs[0].pin = true;
            n.Ins[0].label = "scale";
            n.Ins[0].slider = createSlider(0.001, .5, .1, .01);
            n.name = "Noise";
            n.type = "noise";
            n.Worker = new worker_Noise(n);
            break;
        case "RDfilter":
            n.createPin(true);
            n.createPin(true);
            n.createPin(true);
            n.createPin(true);
            n.createPin(false);
            n.Ins[0].label = "Input";
            n.Ins[0].pin = true;
            n.Ins[1].label = "Feed/Kill rate";
            n.Ins[1].slider = createSlider(-25, 25, 0.01, .01);
            n.Ins[2].label = "Diffusion";
            n.Ins[2].slider = createSlider(0, .5, 0.1, .01);
            n.Ins[3].label = "SeedRate";
            n.Ins[3].slider = createSlider(1, 60, 1, 10);
            n.Outs[0].pin = true;

            n.name = "Reaction Diffusion";
            n.type = "RDfilter";
            n.Worker = new worker_RD(n);
            break;
        case "camera":
            n.createPin(false);
            n.Outs[0].pin = true;
            n.name = "Camera Input";
            n.type = "camera";
            n.Worker = new worker_Camera(n);
            break;
        case "math":
            n.createPin(true);
            n.createPin(true);
            n.createPin(true);
            n.createPin(true);
            n.createPin(false);

            n.Ins[0].pin = true;
            n.Ins[0].label = "Data";
            n.Ins[1].pin = true;
            n.Ins[1].label = "Other";
            n.Ins[1].slider = createSlider(0, 50, .1, 1);
            n.Ins[2].label = "Operation";
            n.Ins[2].select = createSelect();
            n.Ins[2].select.option('add');
            n.Ins[2].select.option('sub');
            n.Ins[2].select.option('mult');
            n.Ins[2].select.option('div');
            n.Ins[2].select.option('pow');
            n.Ins[3].label = "OtherMult";
            n.Ins[3].slider = createSlider(0, 5, 1, .01);
            n.Outs[0].pin = true;
            n.Outs[0].label = "Data";


            n.name = "Math";
            n.type = "math";
            n.Worker = new worker_Math(n);
    }
    if (isBrowser == null || isBrowser == false) {
        n.canGrab = true;
        activeNodes.push(n);
        if (activeNodes.length == 1) {
            previewedNode = activeNodes[0].Shader;
        }
    } else {
        n.canGrab = false;
        n.isBrowser = true;
        Nodes.push(n);
    }

    console.log(n)
    console.log(activeNodes[activeNodes.length - 1])
}

function isGrabbable(object) {
    if (object.canGrab == false) {
        return false;
    } else if (Object.getPrototypeOf(object) == TopBarCategoryElement) {
        return true;
    }
    return true;
}

function calculateViewportSize() {
    viewPortSize = createVector(window.innerWidth - nodeBrowser.width, window.innerHeight);
}

function toCoords(i, size) {
    const x = i % size;
    const y = i / size;
    return createVector(x, y);
}

function GarbageCollection() {
    for (var i = 0; i < activeNodes.length; i++) {
        if (activeNodes[i].kill) {
            console.log("killing " + i)
            activeNodes.splice(i, 1);
        }
    }
}

function removeFrom(array, element) {
    try {
        for (var i = 0; i < array.length; i++) {
            if (array[i] == element) {
                array.splice[i, 1];
            }
        }
    } catch (e) {
        console.log("remove error" + e);
    }
}

function release() {
    linking = false;
    dragNdropping = false;
    grabbing = false;
}

function doubleClicked() {
    userDoubleClicked = true;
    console.log(userDoubleClicked);
}

function mouseWheel(event) {
    nodeBrowser.sliderPos += event.delta * .34;
}

function Save() {
    /* var thingy = JSON.stringify(activeNodes); */
    /* var thingy = JSON.stringify(activeNodes, function(key, value) {
        if (key == 'parent') { return value.id; } else { return value; }
    }) */
    /* var thingy = saveJso(activeNodes, getCircularReplacer()); */
    /* save(thingy, 'mySimulation.json'); */
    saveJSON(activeNodes, "mySimulation.json");
}

function Load() {
    const input = document.querySelector("#load").files;
    console.log(input);
    /* var json = JSON.parse(input); */


}

const getCircularReplacer = () => {
    const seen = new WeakSet();
    return (key, value) => {
        if (typeof value === "object" && value !== null) {
            if (seen.has(value)) {
                return;
            }
            seen.add(value);
        }
        return value;
    };
};